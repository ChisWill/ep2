#!/usr/bin/env php
<?php

declare(strict_types=1);

use Ep\Console\Application;
use Ep\Console\Input;
use Ep\Helper\Arr;

(static function (): void {
    $cwd = getcwd();

    if (file_exists($cwd . '/ep.json')) {
        $options = json_decode(file_get_contents($cwd . '/ep.json'), true);
    } else {
        fwrite(STDERR, "Could not find a ep.json file in {$cwd}" . PHP_EOL);
        exit(1);
    }

    require($options['bootstrap'] ?? './vendor/autoload.php');
    $rootPath = realpath($options['rootPath'] ?? './');
    $configPath = $rootPath . '/' . ltrim($options['configPath'], './');
    unset($options['bootstrap'], $options['rootPath'], $options['configPath']);

    $core = Ep::create($rootPath);

    $config = array_filter(
        Arr::getValues(require($configPath), [
            'rootNamespace',
            'runtimeDir',
            'vendorPath',
            'cipherMethod',
            'diProvider',
            'params'
        ])
    );

    $options['common'] ??= [];
    $options['common']['userRootNamespace'] = $config['rootNamespace'];
    $config['rootNamespace'] = 'Ep';

    $app = $core->config($config)->ready(Application::class);

    $input = Ep::getDi()->get(Input::class);
    foreach ($options as $name => $value) {
        $input->setOption($name, $value);
    }

    exit($app->run($input));
})();
